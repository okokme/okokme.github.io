<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />



  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">






  <meta name="keywords" content="Go,nsq," />










<meta name="description" content="整体流程  nsq&#x2F;nsq.gomain 函数入口在其中。其中含有 flag 包用来解析输入。初始化后，开了四个携程 123456789go func() &amp;#123;	&lt;-signalChan	nsqEndChan &lt;- 1&amp;#125;()signal.Notify(signalChan, os.Interrupt) &#x2F;&#x2F; 实时接受输入信号go topicFactory(*memQu">
<meta property="og:type" content="article">
<meta property="og:title" content="源码学习 | nsq（v0.1.1版本）">
<meta property="og:url" content="http://yoursite.com/2020/06/17/2020-06-17-nsq%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="丛也的blog">
<meta property="og:description" content="整体流程  nsq&#x2F;nsq.gomain 函数入口在其中。其中含有 flag 包用来解析输入。初始化后，开了四个携程 123456789go func() &amp;#123;	&lt;-signalChan	nsqEndChan &lt;- 1&amp;#125;()signal.Notify(signalChan, os.Interrupt) &#x2F;&#x2F; 实时接受输入信号go topicFactory(*memQu">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592384074102-543ef476-693c-4c1a-bf94-407960c64678.png#align=left&display=inline&height=409&margin=%5Bobject%20Object%5D&name=image.png&originHeight=409&originWidth=1048&size=77256&status=done&style=none&width=1048">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592232893366-ad099692-6a35-4843-87d9-2fc5e5126893.png#align=left&display=inline&height=175&margin=%5Bobject%20Object%5D&name=image.png&originHeight=175&originWidth=782&size=30603&status=done&style=none&width=782">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592233035035-13d05928-e7d5-4d60-b514-bc7581fde892.png#align=left&display=inline&height=320&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=735&size=64725&status=done&style=none&width=746">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592234471466-58832552-06e8-427d-a867-2cef5012e977.png#align=left&display=inline&height=360&margin=%5Bobject%20Object%5D&name=image.png&originHeight=360&originWidth=931&size=61693&status=done&style=none&width=931">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592234757000-c84f39a3-200d-4ec5-b0e8-539e37143f75.png#align=left&display=inline&height=318&margin=%5Bobject%20Object%5D&name=image.png&originHeight=318&originWidth=817&size=56297&status=done&style=none&width=817">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592235216376-103ba73e-2a39-4971-be27-f62a9e53bc83.png#align=left&display=inline&height=821&margin=%5Bobject%20Object%5D&name=image.png&originHeight=821&originWidth=1378&size=113843&status=done&style=none&width=1378">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592235887956-83493fb5-d6aa-4575-b2f0-594e7f992b70.png#align=left&display=inline&height=195&margin=%5Bobject%20Object%5D&name=image.png&originHeight=195&originWidth=883&size=32486&status=done&style=none&width=883">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592281184516-a2d0d2b6-4a30-465b-98f2-1f36003e2b73.png#align=left&display=inline&height=135&margin=%5Bobject%20Object%5D&name=image.png&originHeight=135&originWidth=810&size=20099&status=done&style=none&width=810">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592281777427-eed6aa6f-3011-4fe5-b4cf-fbafc72b9766.png#align=left&display=inline&height=618&margin=%5Bobject%20Object%5D&name=image.png&originHeight=618&originWidth=920&size=93732&status=done&style=none&width=920">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592287475041-dd9af87d-24ae-43fa-bbcd-84173cb59f01.png#align=left&display=inline&height=467&margin=%5Bobject%20Object%5D&name=image.png&originHeight=467&originWidth=926&size=47587&status=done&style=none&width=926">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592287721809-b65466bb-3d88-469c-8d7b-813625904030.png#align=left&display=inline&height=359&margin=%5Bobject%20Object%5D&name=image.png&originHeight=359&originWidth=919&size=47030&status=done&style=none&width=919">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592296780598-07c85a42-d45d-4617-917d-733fb78b5602.png#align=left&display=inline&height=96&margin=%5Bobject%20Object%5D&name=image.png&originHeight=96&originWidth=910&size=14112&status=done&style=none&width=910">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592297795040-5768c42f-cda4-404c-9a65-96d3d06626b8.png#align=left&display=inline&height=720&margin=%5Bobject%20Object%5D&name=image.png&originHeight=720&originWidth=923&size=113796&status=done&style=none&width=923">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592298402021-a402a326-f7bf-4d42-bba6-238ac001887a.png#align=left&display=inline&height=135&margin=%5Bobject%20Object%5D&name=image.png&originHeight=135&originWidth=900&size=13136&status=done&style=none&width=900">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592306578289-f8b7d08c-de1a-43e8-9185-e82c6c42c7c7.png#align=left&display=inline&height=95&margin=%5Bobject%20Object%5D&name=image.png&originHeight=95&originWidth=893&size=11468&status=done&style=none&width=893">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592312806398-e0e41a18-6f6f-470c-8512-fa75122bbab7.png#align=left&display=inline&height=716&margin=%5Bobject%20Object%5D&name=image.png&originHeight=716&originWidth=906&size=89701&status=done&style=none&width=906">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592314002618-a7c400f5-a57a-405d-b123-e4ce55727941.png#align=left&display=inline&height=745&margin=%5Bobject%20Object%5D&name=image.png&originHeight=745&originWidth=882&size=85609&status=done&style=none&width=882">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592316011911-ba1488e4-fd3e-4f5a-9d51-583dbcedda52.png#align=left&display=inline&height=580&margin=%5Bobject%20Object%5D&name=image.png&originHeight=580&originWidth=915&size=70388&status=done&style=none&width=915">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592316462545-bfd7ce34-32ac-4829-8bb1-8a4a0b46a952.png#align=left&display=inline&height=586&margin=%5Bobject%20Object%5D&name=image.png&originHeight=586&originWidth=1031&size=83400&status=done&style=none&width=1031">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592322842800-6a94d6c7-2b71-4643-9156-12834afdcadc.png#align=left&display=inline&height=363&margin=%5Bobject%20Object%5D&name=image.png&originHeight=363&originWidth=964&size=71758&status=done&style=none&width=964">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592322915992-eb87c669-15ba-4182-84d2-64b7c14988e8.png#align=left&display=inline&height=376&margin=%5Bobject%20Object%5D&name=image.png&originHeight=376&originWidth=1061&size=71253&status=done&style=none&width=1061">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326301562-af667ed3-feb6-44f2-8d87-f05cc4e9842e.png#align=left&display=inline&height=183&margin=%5Bobject%20Object%5D&name=image.png&originHeight=183&originWidth=823&size=31752&status=done&style=none&width=823">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326559651-6a68530c-c736-4391-b722-d14e409c170f.png#align=left&display=inline&height=131&margin=%5Bobject%20Object%5D&name=image.png&originHeight=131&originWidth=779&size=23264&status=done&style=none&width=779">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326322487-eb52de85-b44f-4862-9cf5-f5b6211d63a0.png#align=left&display=inline&height=120&margin=%5Bobject%20Object%5D&name=image.png&originHeight=120&originWidth=776&size=14912&status=done&style=none&width=776">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326159054-9296bbef-6ffe-46ad-a4b3-75a3937cff7e.png#align=left&display=inline&height=613&margin=%5Bobject%20Object%5D&name=image.png&originHeight=613&originWidth=1015&size=93510&status=done&style=none&width=1015">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326882709-2bd02260-536c-47af-b621-ec9558b2193c.png#align=left&display=inline&height=462&margin=%5Bobject%20Object%5D&name=image.png&originHeight=462&originWidth=935&size=50677&status=done&style=none&width=935">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327161096-f68d8d7f-06d2-4dd1-8c53-b80d9c410201.png#align=left&display=inline&height=599&margin=%5Bobject%20Object%5D&name=image.png&originHeight=599&originWidth=1030&size=83573&status=done&style=none&width=1030">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327263922-271cf7cb-da3a-4cbd-afbf-46c0d675cbd6.png#align=left&display=inline&height=822&margin=%5Bobject%20Object%5D&name=image.png&originHeight=822&originWidth=1020&size=140019&status=done&style=none&width=1020">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327292380-d2c370d2-d050-45ba-8a6f-664ae3ac5b93.png#align=left&display=inline&height=261&margin=%5Bobject%20Object%5D&name=image.png&originHeight=261&originWidth=1028&size=39817&status=done&style=none&width=1028">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327446541-4fac5874-a2ca-4980-8a9a-ea5a24449f85.png#align=left&display=inline&height=298&margin=%5Bobject%20Object%5D&name=image.png&originHeight=298&originWidth=922&size=42058&status=done&style=none&width=922">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327526947-d061a79c-7856-4b00-b0d2-ce0dce4cb66c.png#align=left&display=inline&height=820&margin=%5Bobject%20Object%5D&name=image.png&originHeight=820&originWidth=1031&size=144140&status=done&style=none&width=1031">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327780152-799ad7dd-d14a-43f8-9222-b7d52554bd17.png#align=left&display=inline&height=228&margin=%5Bobject%20Object%5D&name=image.png&originHeight=228&originWidth=807&size=34433&status=done&style=none&width=807">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327981696-5f3b8fe4-cf3f-4866-bbd1-81cb40f1ee67.png#align=left&display=inline&height=106&margin=%5Bobject%20Object%5D&name=image.png&originHeight=106&originWidth=765&size=21039&status=done&style=none&width=765">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327882023-5f3162f7-9871-4548-a026-dcd76969bf61.png#align=left&display=inline&height=94&margin=%5Bobject%20Object%5D&name=image.png&originHeight=94&originWidth=709&size=15151&status=done&style=none&width=709">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592328014177-89cb74e9-06a1-464b-9374-c582a6c5f875.png#align=left&display=inline&height=637&margin=%5Bobject%20Object%5D&name=image.png&originHeight=637&originWidth=815&size=70636&status=done&style=none&width=815">
<meta property="article:published_time" content="2020-06-17T09:05:07.000Z">
<meta property="article:modified_time" content="2020-06-17T09:07:12.818Z">
<meta property="article:author" content="丛也">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="nsq">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2020/png/795299/1592384074102-543ef476-693c-4c1a-bf94-407960c64678.png#align=left&display=inline&height=409&margin=%5Bobject%20Object%5D&name=image.png&originHeight=409&originWidth=1048&size=77256&status=done&style=none&width=1048">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/17/2020-06-17-nsq源码学习/"/>





  <title>源码学习 | nsq（v0.1.1版本） | 丛也的blog</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">丛也的blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/17/2020-06-17-nsq%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="丛也">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="丛也的blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">源码学习 | nsq（v0.1.1版本）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-17T17:05:07+08:00">
                2020-06-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/nsq/" itemprop="url" rel="index">
                    <span itemprop="name">nsq</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h2><p><a name="hLX4O"></a></p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592384074102-543ef476-693c-4c1a-bf94-407960c64678.png#align=left&display=inline&height=409&margin=%5Bobject%20Object%5D&name=image.png&originHeight=409&originWidth=1048&size=77256&status=done&style=none&width=1048" alt="image.png"></h2><p><a name="zmzIO"></a></p>
<h2 id="nsq-nsq-go"><a href="#nsq-nsq-go" class="headerlink" title="nsq/nsq.go"></a>nsq/nsq.go</h2><p>main 函数入口在其中。其中含有 flag 包用来解析输入。<br />初始化后，开了四个携程</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	&lt;-signalChan</span><br><span class="line">	nsqEndChan &lt;- <span class="number">1</span></span><br><span class="line">&#125;()</span><br><span class="line">signal.Notify(signalChan, os.Interrupt) <span class="comment">// 实时接受输入信号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> topicFactory(*memQueueSize)</span><br><span class="line"><span class="keyword">go</span> uuidFactory()</span><br><span class="line"><span class="keyword">go</span> tcpServer(*bindAddress, strconv.Itoa(*tcpPort))</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpServer(*bindAddress, strconv.Itoa(*webPort), nsqEndChan)</span><br></pre></td></tr></table></figure>

<p>在 httpServer 执行完后，证明需要结束时，最后遍历 topicMap，将 topic 结束。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, topic := <span class="keyword">range</span> topicMap &#123;</span><br><span class="line">    topic.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结：该文件是程序总入口和控制中心，控制程序开始和结束，贯穿始终。<br /></p>
<p><a name="8Af8m"></a></p>
<h2 id="nsq-topic-go"><a href="#nsq-topic-go" class="headerlink" title="nsq/topic.go"></a>nsq/topic.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Topic <span class="keyword">struct</span> &#123;</span><br><span class="line">	name                 <span class="keyword">string</span> <span class="comment">// 每个 topic 都有一个名称</span></span><br><span class="line">	newChannelChan       <span class="keyword">chan</span> ChanReq <span class="comment">// 每个 topic 对应有很多 chan，用于对应订阅者，此变量用于记录新增加的订阅者的 chan</span></span><br><span class="line">	channelMap           <span class="keyword">map</span>[<span class="keyword">string</span>]*Channel <span class="comment">// 订阅者对应的 channel 的 map 记录</span></span><br><span class="line">	backend              NSQueue <span class="comment">// msg 的缓存区</span></span><br><span class="line">	incomingMessageChan  <span class="keyword">chan</span> *Message <span class="comment">// 新到 msg 的 chan 通知，用于发布者写入通知</span></span><br><span class="line">	msgChan              <span class="keyword">chan</span> *Message <span class="comment">// 用于传递 msg 的 chan，用于中间发布给</span></span><br><span class="line">	routerSyncChan       <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 标记 chan，用于标记有 msg 同步的开始</span></span><br><span class="line">	readSyncChan         <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 标记 chan，用于标记 msg 同步的结束</span></span><br><span class="line">	exitChan             <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// </span></span><br><span class="line">	channelWriterStarted <span class="keyword">bool</span> <span class="comment">// 初始化时，开启 MessagePump 协程开启的标记</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有两个必要的全局变量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> topicMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*Topic) <span class="comment">// 存储所有 topic</span></span><br><span class="line"><span class="keyword">var</span> newTopicChan = <span class="built_in">make</span>(<span class="keyword">chan</span> ChanReq) <span class="comment">// 用于生产和获取 topic</span></span><br></pre></td></tr></table></figure>

<p><a name="rRjjf"></a></p>
<h3 id="GetTopic"><a href="#GetTopic" class="headerlink" title="GetTopic"></a>GetTopic</h3><p>topic 的入口在 GetTopic<br /><del><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592232893366-ad099692-6a35-4843-87d9-2fc5e5126893.png#align=left&display=inline&height=175&margin=%5Bobject%20Object%5D&name=image.png&originHeight=175&originWidth=782&size=30603&status=done&style=none&width=782" alt="image.png"></del><br /><del><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592233035035-13d05928-e7d5-4d60-b514-bc7581fde892.png#align=left&display=inline&height=320&margin=%5Bobject%20Object%5D&name=image.png&originHeight=315&originWidth=735&size=64725&status=done&style=none&width=746" alt="image.png"></del><br />可以看到它的上层调用是在连接层<br />在 GetTopic 中，创建一个 topicChan， 并将其通过 newTopicChan 发送给 topicFactory</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">newTopicChan &lt;- ChanReq&#123;topicName, topicChan&#125; <span class="comment">// GetTopic 中放</span></span><br><span class="line">topicReq := &lt;-newTopicChan <span class="comment">// topicFactory 中取</span></span><br></pre></td></tr></table></figure>

<p><a name="TToRP"></a></p>
<h3 id="topicFactory"><a href="#topicFactory" class="headerlink" title="topicFactory"></a>topicFactory</h3><p>main 中就开了一个 go topicFactory(*memQueueSize)，它是  main 函数的启动模块之一<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592234471466-58832552-06e8-427d-a867-2cef5012e977.png#align=left&display=inline&height=360&margin=%5Bobject%20Object%5D&name=image.png&originHeight=360&originWidth=931&size=61693&status=done&style=none&width=931" alt="image.png"><br />在 for 循环中<br />从 newTopicChan 中接受消息，然后查找该 topic 是否存在在现有的 topicMap 中，不存在就新建一个 topic(NewTopic)。然后将查到的或者新建的 topic 信息通过 retChan 返回给调用者。<br><a name="cPZrh"></a></p>
<h3 id="NewTopic"><a href="#NewTopic" class="headerlink" title="NewTopic"></a>NewTopic</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592234757000-c84f39a3-200d-4ec5-b0e8-539e37143f75.png#align=left&display=inline&height=318&margin=%5Bobject%20Object%5D&name=image.png&originHeight=318&originWidth=817&size=56297&status=done&style=none&width=817" alt="image.png"><br />初始化之后，在第 35 行开启了一个协程 topic.Router。每个协程都有一个处理协程（router），所有的操作通过 chan 将信息发送到 Router 中，Router 中根据不同的 chan，进行不同的操作。<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592235216376-103ba73e-2a39-4971-be27-f62a9e53bc83.png#align=left&display=inline&height=821&margin=%5Bobject%20Object%5D&name=image.png&originHeight=821&originWidth=1378&size=113843&status=done&style=none&width=1378" alt="image.png"><br />router 中 接收 Channel 的信息<br><a name="7LvYp"></a></p>
<h4 id="newChannelChan"><a href="#newChannelChan" class="headerlink" title="newChannelChan"></a>newChannelChan</h4><p>入口是 GetChannel：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592235887956-83493fb5-d6aa-4575-b2f0-594e7f992b70.png#align=left&display=inline&height=195&margin=%5Bobject%20Object%5D&name=image.png&originHeight=195&originWidth=883&size=32486&status=done&style=none&width=883" alt="image.png"><br />通过 newChannelChan 来传递信息<br />在一个 topic 中会对应多个 channel，用于订阅者，并且每个订阅者的 channel 都有一个 name 用于标识（122行）。然后从 channelMap 中查找对应的channel，如果没有找到，则初始化 NewChannel。通过 retChan 将 channel 信息返回给调用者。<br />针对每个 channel 都会开启一个协程 MessagePump（131）<br><a name="fIITW"></a></p>
<h4 id="incomingMessageChan"><a href="#incomingMessageChan" class="headerlink" title="incomingMessageChan"></a>incomingMessageChan</h4><p>入口为 PutMessage：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592281184516-a2d0d2b6-4a30-465b-98f2-1f36003e2b73.png#align=left&display=inline&height=135&margin=%5Bobject%20Object%5D&name=image.png&originHeight=135&originWidth=810&size=20099&status=done&style=none&width=810" alt="image.png"><br />用于发布者调用，发布一个信息。<br />将 msg 发送到 msgChan 中（136行）<br />若 msgChan 阻塞，发送到 backend 中（139行）<br><a name="8dKzV"></a></p>
<h4 id="readSyncChan"><a href="#readSyncChan" class="headerlink" title="readSyncChan"></a>readSyncChan</h4><p>标记 read sync start，并等待 read sync end（148行）<br><a name="c9r4S"></a></p>
<h4 id="exitChan"><a href="#exitChan" class="headerlink" title="exitChan"></a>exitChan</h4><p>结束，return<br><a name="ckdR0"></a></p>
<h3 id="MessagePump"><a href="#MessagePump" class="headerlink" title="MessagePump"></a>MessagePump</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592281777427-eed6aa6f-3011-4fe5-b4cf-fbafc72b9766.png#align=left&display=inline&height=618&margin=%5Bobject%20Object%5D&name=image.png&originHeight=618&originWidth=920&size=93732&status=done&style=none&width=920" alt="image.png"><br />每个订阅者 channel，都会开启一个 MessagePump<br />在 for 循环中，从 msgChan 中获取 msg，或从 backend 中获取缓冲区未发布的 msg。标记 read sync start，然后遍历所有 Channel，将读取的 msg，发布给所有的 channel。发送完后标记 read sync read end<br><a name="PAePF"></a></p>
<h2 id="nsq-uuid-go"><a href="#nsq-uuid-go" class="headerlink" title="nsq/uuid.go"></a>nsq/uuid.go</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592287475041-dd9af87d-24ae-43fa-bbcd-84173cb59f01.png#align=left&display=inline&height=467&margin=%5Bobject%20Object%5D&name=image.png&originHeight=467&originWidth=926&size=47587&status=done&style=none&width=926" alt="image.png"><br />生成 uid 模块<br><a name="gN2Pk"></a></p>
<h2 id="nsq-tcp-go"><a href="#nsq-tcp-go" class="headerlink" title="nsq/tcp.go"></a>nsq/tcp.go</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592287721809-b65466bb-3d88-469c-8d7b-813625904030.png#align=left&display=inline&height=359&margin=%5Bobject%20Object%5D&name=image.png&originHeight=359&originWidth=919&size=47030&status=done&style=none&width=919" alt="image.png"><br />tcp 连接，for 循环中，每接到一个连接(每个tcp连接都会构建一个client)，开一个协程来去执行 client.Handler()<br><a name="Zw6EH"></a></p>
<h2 id="nsq-client-go"><a href="#nsq-client-go" class="headerlink" title="nsq/client.go"></a>nsq/client.go</h2><p>client 的结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Client <span class="keyword">struct</span> &#123;</span><br><span class="line">	conn    net.Conn <span class="comment">// 连接信息</span></span><br><span class="line">	state   <span class="keyword">int</span> <span class="comment">// 状态信息</span></span><br><span class="line">	channel *Channel <span class="comment">// 订阅 channel 信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 state 状态有四种：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	clientInit         = <span class="number">0</span></span><br><span class="line">	clientWaitGet      = <span class="number">1</span></span><br><span class="line">	clientWaitAck      = <span class="number">2</span></span><br><span class="line">	clientWaitResponse = <span class="number">3</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>初始化 client：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592296780598-07c85a42-d45d-4617-917d-733fb78b5602.png#align=left&display=inline&height=96&margin=%5Bobject%20Object%5D&name=image.png&originHeight=96&originWidth=910&size=14112&status=done&style=none&width=910" alt="image.png"><br />在 tcpServer 里，每一个连接都会初始化一个 client，client := NewClient(clientConn)<br />每个客户端都会执行 Handle：<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592297795040-5768c42f-cda4-404c-9a65-96d3d06626b8.png#align=left&display=inline&height=720&margin=%5Bobject%20Object%5D&name=image.png&originHeight=720&originWidth=923&size=113796&status=done&style=none&width=923" alt="image.png"><br />其中，客户端应该通过发送四个字节的序列来初始化自身，该序列指其打算通信的版本，这样可以利于升级<br />查找到对应版本号的协议（91行）<br />真正处理在 protocol.IOLoop(c)（98行）<br><a name="yjiT7"></a></p>
<h2 id="nsq-protocol-go"><a href="#nsq-protocol-go" class="headerlink" title="nsq/protocol.go"></a>nsq/protocol.go</h2><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592298402021-a402a326-f7bf-4d42-bba6-238ac001887a.png#align=left&display=inline&height=135&margin=%5Bobject%20Object%5D&name=image.png&originHeight=135&originWidth=900&size=13136&status=done&style=none&width=900" alt="image.png"><br />提供了一组接口<br><a name="rNJed"></a></p>
<h2 id="nsq-protocol-v1-go"><a href="#nsq-protocol-v1-go" class="headerlink" title="nsq/protocol_v1.go"></a>nsq/protocol_v1.go</h2><p>v1 版本的协议:<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592306578289-f8b7d08c-de1a-43e8-9185-e82c6c42c7c7.png#align=left&display=inline&height=95&margin=%5Bobject%20Object%5D&name=image.png&originHeight=95&originWidth=893&size=11468&status=done&style=none&width=893" alt="image.png"><br><a name="tcZsj"></a></p>
<h3 id="IOLoop"><a href="#IOLoop" class="headerlink" title="IOLoop"></a>IOLoop</h3><p>初始化协议：<strong>(这部分我没怎么看懂)</strong><br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592312806398-e0e41a18-6f6f-470c-8512-fa75122bbab7.png#align=left&display=inline&height=716&margin=%5Bobject%20Object%5D&name=image.png&originHeight=716&originWidth=906&size=89701&status=done&style=none&width=906" alt="image.png"><br />初始化一个 buffer 的 reader<br />在 for 循环中，开始从连接中读取数据<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592314002618-a7c400f5-a57a-405d-b123-e4ce55727941.png#align=left&display=inline&height=745&margin=%5Bobject%20Object%5D&name=image.png&originHeight=745&originWidth=882&size=85609&status=done&style=none&width=882" alt="image.png"><br />查找到 MethodByName（54行），调用查到的 Method（56行）并调用，将返回结果赋给 returnValues，然后看 returnValues 返回有没有错误后，将其 [1] 作为返回值表示出来，返回给 client.Write.<br><a name="uu5mD"></a></p>
<h3 id="SUB"><a href="#SUB" class="headerlink" title="SUB"></a>SUB</h3><p>协议中提供的操作<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592316011911-ba1488e4-fd3e-4f5a-9d51-583dbcedda52.png#align=left&display=inline&height=580&margin=%5Bobject%20Object%5D&name=image.png&originHeight=580&originWidth=915&size=70388&status=done&style=none&width=915" alt="image.png"><br />获取 topic（112行）<br />获取 channel（112行）<br />将 client 加到 channel 管理（114）<br><a name="tgMaG"></a></p>
<h3 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592316462545-bfd7ce34-32ac-4829-8bb1-8a4a0b46a952.png#align=left&display=inline&height=586&margin=%5Bobject%20Object%5D&name=image.png&originHeight=586&originWidth=1031&size=83400&status=done&style=none&width=1031" alt="image.png"><br />状态为 clientWaitGet 的开始向下。首先从 client.channel 中取出 Message（127行），然后将 msg 格式化到 buf 中，然后将 buf return<br><a name="fDKZH"></a></p>
<h2 id="nsq-channel-go"><a href="#nsq-channel-go" class="headerlink" title="nsq/channel.go"></a>nsq/channel.go</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Channel <span class="keyword">struct</span> &#123;</span><br><span class="line">	name                <span class="keyword">string</span> <span class="comment">// 每个 channel 有对应自己的名字</span></span><br><span class="line">	addClientChan       <span class="keyword">chan</span> ChanReq  <span class="comment">// tcp 连接对应的 client 加入 channel 中的传送 chan</span></span><br><span class="line">	removeClientChan    <span class="keyword">chan</span> ChanReq <span class="comment">// 用于删除 client 的传送 chan</span></span><br><span class="line">	clients             []*Client <span class="comment">// 保存 channel 中的所有连接</span></span><br><span class="line">	backend             NSQueue <span class="comment">// msg 缓冲区</span></span><br><span class="line">	incomingMessageChan <span class="keyword">chan</span> *Message <span class="comment">// msg 到来的 chan</span></span><br><span class="line">	msgChan             <span class="keyword">chan</span> *Message <span class="comment">// msg 的传送</span></span><br><span class="line">	inFlightMessageChan <span class="keyword">chan</span> *Message</span><br><span class="line">	requeueMessageChan  <span class="keyword">chan</span> ChanReq</span><br><span class="line">	finishMessageChan   <span class="keyword">chan</span> ChanReq</span><br><span class="line">	exitChan            <span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">	inFlightMessages    <span class="keyword">map</span>[<span class="keyword">string</span>]*Message <span class="comment">// ?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="6igsd"></a></p>
<h3 id="NewChannel"><a href="#NewChannel" class="headerlink" title="NewChannel"></a>NewChannel</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592322842800-6a94d6c7-2b71-4643-9156-12834afdcadc.png#align=left&display=inline&height=363&margin=%5Bobject%20Object%5D&name=image.png&originHeight=363&originWidth=964&size=71758&status=done&style=none&width=964" alt="image.png"><br />在 topic 的 router 中调用<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592322915992-eb87c669-15ba-4182-84d2-64b7c14988e8.png#align=left&display=inline&height=376&margin=%5Bobject%20Object%5D&name=image.png&originHeight=376&originWidth=1061&size=71253&status=done&style=none&width=1061" alt="image.png"><br />和 topic 一样，Channel 也采用了 router 模式，初始化 channel 后，所有信号都是发送到 router 来操作。<br><a name="UywFn"></a></p>
<h3 id="AddClient"><a href="#AddClient" class="headerlink" title="AddClient"></a>AddClient</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326301562-af667ed3-feb6-44f2-8d87-f05cc4e9842e.png#align=left&display=inline&height=183&margin=%5Bobject%20Object%5D&name=image.png&originHeight=183&originWidth=823&size=31752&status=done&style=none&width=823" alt="image.png"><br />Channel 中新增 client，把信号发到 addClientChan，Router 中处理 addClientChan<br><a name="hl2zt"></a></p>
<h3 id="RemoveClient"><a href="#RemoveClient" class="headerlink" title="RemoveClient"></a>RemoveClient</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326559651-6a68530c-c736-4391-b722-d14e409c170f.png#align=left&display=inline&height=131&margin=%5Bobject%20Object%5D&name=image.png&originHeight=131&originWidth=779&size=23264&status=done&style=none&width=779" alt="image.png"><br />Channel 移除该 client，把信号发送到 removeClientChan，Router 中处理 removeClientChan<br><a name="hjniy"></a></p>
<h3 id="PutMessage"><a href="#PutMessage" class="headerlink" title="PutMessage"></a>PutMessage</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326322487-eb52de85-b44f-4862-9cf5-f5b6211d63a0.png#align=left&display=inline&height=120&margin=%5Bobject%20Object%5D&name=image.png&originHeight=120&originWidth=776&size=14912&status=done&style=none&width=776" alt="image.png"><br />外部消息发送到 Channel 中，通过 incomingMessageChan 发送<img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326159054-9296bbef-6ffe-46ad-a4b3-75a3937cff7e.png#align=left&display=inline&height=613&margin=%5Bobject%20Object%5D&name=image.png&originHeight=613&originWidth=1015&size=93510&status=done&style=none&width=1015" alt="image.png"><br />PutMessage 在 tpoic 的 MessagePump 中有调用到，然后在 channel.Router 中处理<br><a name="hF4eR"></a></p>
<h3 id="GetMessage"><a href="#GetMessage" class="headerlink" title="GetMessage"></a>GetMessage</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592326882709-2bd02260-536c-47af-b621-ec9558b2193c.png#align=left&display=inline&height=462&margin=%5Bobject%20Object%5D&name=image.png&originHeight=462&originWidth=935&size=50677&status=done&style=none&width=935" alt="image.png"><br />对外还有一个接口 GetMessage，从 msg / backend 取到 ，protocol_v1 的 GET 接口有用到<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327161096-f68d8d7f-06d2-4dd1-8c53-b80d9c410201.png#align=left&display=inline&height=599&margin=%5Bobject%20Object%5D&name=image.png&originHeight=599&originWidth=1030&size=83573&status=done&style=none&width=1030" alt="image.png"><br><a name="IdpP2"></a></p>
<h3 id="router"><a href="#router" class="headerlink" title="router"></a>router</h3><p>router 处理 channel 消息的多路复用，包括向 Channel 添加客户端<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327263922-271cf7cb-da3a-4cbd-afbf-46c0d675cbd6.png#align=left&display=inline&height=822&margin=%5Bobject%20Object%5D&name=image.png&originHeight=822&originWidth=1020&size=140019&status=done&style=none&width=1020" alt="image.png">)<img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327292380-d2c370d2-d050-45ba-8a6f-664ae3ac5b93.png#align=left&display=inline&height=261&margin=%5Bobject%20Object%5D&name=image.png&originHeight=261&originWidth=1028&size=39817&status=done&style=none&width=1028" alt="image.png"><br />这部分开了一个新的协程来处理具体的消息存入与取出<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327446541-4fac5874-a2ca-4980-8a9a-ea5a24449f85.png#align=left&display=inline&height=298&margin=%5Bobject%20Object%5D&name=image.png&originHeight=298&originWidth=922&size=42058&status=done&style=none&width=922" alt="image.png"><br />pop 与 push in inFlightMessages<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327526947-d061a79c-7856-4b00-b0d2-ce0dce4cb66c.png#align=left&display=inline&height=820&margin=%5Bobject%20Object%5D&name=image.png&originHeight=820&originWidth=1031&size=144140&status=done&style=none&width=1031" alt="image.png"><br />处理Channel 中的 client ，操作与 topic 类似<br><a name="rmrih"></a></p>
<h2 id="nsq-http-go"><a href="#nsq-http-go" class="headerlink" title="nsq/http.go"></a>nsq/http.go</h2><p><a name="UsiB1"></a></p>
<h3 id="httpServer"><a href="#httpServer" class="headerlink" title="httpServer"></a>httpServer</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327780152-799ad7dd-d14a-43f8-9222-b7d52554bd17.png#align=left&display=inline&height=228&margin=%5Bobject%20Object%5D&name=image.png&originHeight=228&originWidth=807&size=34433&status=done&style=none&width=807" alt="image.png"><br />两个接口， /ping 和 /put<br />httpServer 也是 main 函数的主要模块之一<br /><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327981696-5f3b8fe4-cf3f-4866-bbd1-81cb40f1ee67.png#align=left&display=inline&height=106&margin=%5Bobject%20Object%5D&name=image.png&originHeight=106&originWidth=765&size=21039&status=done&style=none&width=765" alt="image.png"><br><a name="Awrz0"></a></p>
<h3 id="pingHandler"><a href="#pingHandler" class="headerlink" title="pingHandler"></a>pingHandler</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592327882023-5f3162f7-9871-4548-a026-dcd76969bf61.png#align=left&display=inline&height=94&margin=%5Bobject%20Object%5D&name=image.png&originHeight=94&originWidth=709&size=15151&status=done&style=none&width=709" alt="image.png"><br />保持畅通<br><a name="Hctuj"></a></p>
<h3 id="putHandler"><a href="#putHandler" class="headerlink" title="putHandler"></a>putHandler</h3><p><img src="https://cdn.nlark.com/yuque/0/2020/png/795299/1592328014177-89cb74e9-06a1-464b-9374-c582a6c5f875.png#align=left&display=inline&height=637&margin=%5Bobject%20Object%5D&name=image.png&originHeight=637&originWidth=815&size=70636&status=done&style=none&width=815" alt="image.png"><br />86-87 获取 topic，将 msg 发送进 topic<br><a name="Hb7SW"></a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>所有模块都分析完了，现在把这些模块串起来。<br /><br><br />tcp模块监听链接，每个链接生成一个client，client通过Protocol与channel联系起来。<br />在Protocol中提供，SUB、GET操作，client提供write供Protocol调用<br />在SUB中，提供将client与channel联系起来。<br />在GET中，提供将client从channel中获取订阅的msg，并调用client的write通过tcp发送给订阅者<br /><br><br />每个topic包含多个channel，每个channel对应有一个MessagePump，用于从topic中将msg分发给每个channel。topic中提供GetChannel用于创建和获取channel。<br /><br><br />topic提供一个topicFactory用于创建和获取topic。<br /><br><br />topic提供PutMessage用于发布者发布msg。而在http模块中，提供putHandler，用于发布者发布msg，通过在putHandler中调用PutMessage接口，将msg发布到topic中。<br /><br><br />整个过程就是如此。在这个v0.1.1版本中，最主要的流程都有了。但此版本只是一个单机系统。还不是分布式系统。<br /></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Go/" rel="tag"><i class="fa fa-tag"></i> Go</a>
          
            <a href="/tags/nsq/" rel="tag"><i class="fa fa-tag"></i> nsq</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/16/%E9%9A%8F%E8%AE%B0/" rel="next" title="随记">
                <i class="fa fa-chevron-left"></i> 随记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">丛也</p>
              <p class="site-description motion-element" itemprop="description">今天应做的事没有做，明天再早也是耽误了</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
		<a href="/archives/">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#整体流程"><span class="nav-number">1.</span> <span class="nav-text">整体流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#"><span class="nav-number">2.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-nsq-go"><span class="nav-number">3.</span> <span class="nav-text">nsq&#x2F;nsq.go</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-topic-go"><span class="nav-number">4.</span> <span class="nav-text">nsq&#x2F;topic.go</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GetTopic"><span class="nav-number">4.1.</span> <span class="nav-text">GetTopic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#topicFactory"><span class="nav-number">4.2.</span> <span class="nav-text">topicFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NewTopic"><span class="nav-number">4.3.</span> <span class="nav-text">NewTopic</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#newChannelChan"><span class="nav-number">4.3.1.</span> <span class="nav-text">newChannelChan</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#incomingMessageChan"><span class="nav-number">4.3.2.</span> <span class="nav-text">incomingMessageChan</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#readSyncChan"><span class="nav-number">4.3.3.</span> <span class="nav-text">readSyncChan</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exitChan"><span class="nav-number">4.3.4.</span> <span class="nav-text">exitChan</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MessagePump"><span class="nav-number">4.4.</span> <span class="nav-text">MessagePump</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-uuid-go"><span class="nav-number">5.</span> <span class="nav-text">nsq&#x2F;uuid.go</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-tcp-go"><span class="nav-number">6.</span> <span class="nav-text">nsq&#x2F;tcp.go</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-client-go"><span class="nav-number">7.</span> <span class="nav-text">nsq&#x2F;client.go</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-protocol-go"><span class="nav-number">8.</span> <span class="nav-text">nsq&#x2F;protocol.go</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-protocol-v1-go"><span class="nav-number">9.</span> <span class="nav-text">nsq&#x2F;protocol_v1.go</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IOLoop"><span class="nav-number">9.1.</span> <span class="nav-text">IOLoop</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SUB"><span class="nav-number">9.2.</span> <span class="nav-text">SUB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Get"><span class="nav-number">9.3.</span> <span class="nav-text">Get</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-channel-go"><span class="nav-number">10.</span> <span class="nav-text">nsq&#x2F;channel.go</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NewChannel"><span class="nav-number">10.1.</span> <span class="nav-text">NewChannel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AddClient"><span class="nav-number">10.2.</span> <span class="nav-text">AddClient</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RemoveClient"><span class="nav-number">10.3.</span> <span class="nav-text">RemoveClient</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PutMessage"><span class="nav-number">10.4.</span> <span class="nav-text">PutMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetMessage"><span class="nav-number">10.5.</span> <span class="nav-text">GetMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#router"><span class="nav-number">10.6.</span> <span class="nav-text">router</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nsq-http-go"><span class="nav-number">11.</span> <span class="nav-text">nsq&#x2F;http.go</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#httpServer"><span class="nav-number">11.1.</span> <span class="nav-text">httpServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pingHandler"><span class="nav-number">11.2.</span> <span class="nav-text">pingHandler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#putHandler"><span class="nav-number">11.3.</span> <span class="nav-text">putHandler</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">12.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">丛也</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
